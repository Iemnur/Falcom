from Falcom.ED84.Parser.scena_writer_helper import *

origFunc: Dict[str, Callable] = {}

def funcCallBack(name: str, func: Callable):
    hooks = [
        AniWalk,
        AniRun,
        AniBtlInit,
        AniBtlAttack,
    ]

    for f in hooks:
        if f.__name__ == name:
            origFunc[name] = func
            return f

def runCallBack(g):
    from Falcom.ED84.Parser.scena_writer import _gScena as scena
    for f in [
        AniBtlAttack_Damage,
    ]:
        scena.Code(f.__name__)(f)

def _init():
    from Falcom.ED84.Parser.scena_writer import _gScena as scena
    scena.registerFuncCallback(funcCallBack)
    scena.registerRunCallback(runCallBack)

_init()

def AniWalk():
    Call(ScriptId.Current, 'SpringOff')

    If(
        (
            (Expr.Eval, "ChrPhysicsCmd(0x02, 0xFFFE, 0x00000000)"),
            (Expr.PushLong, 0x10),
            Expr.And,
            Expr.Return,
        ),
        'loc_7FE7',
    )

    Call(ScriptId.Current, 'ShowEquip')
    PlayChrAnimeClip(0xFFFE, 'BTL_WALK', 0x01, 0x00, 0x00, 0x00, 0x00, -2.0, -1.0, -1.0, -1.0, 0x00, 0x00)

    Jump('loc_800F')

    label('loc_7FE7')

    ExecExpressionWithReg(
        0x02,
        (
            (Expr.PushLong, 0x1),
            Expr.Nop,
            Expr.Return,
        ),
    )

    PlayChrAnimeClip(0xFFFE, 'BTL_WAIT', 0x01, 0x00, 0x00, 0x00, 0x00, -2.0, -1.0, -1.0, -1.0, 0x00, 0x00)

    label('loc_800F')

    WaitAnimeClip(0xFFFE, 0.0, 0x00)

    Return()

def AniRun():
    Call(ScriptId.Current, 'SpringOff')

    If(
        (
            (Expr.Eval, "ChrPhysicsCmd(0x02, 0xFFFE, 0x00000000)"),
            (Expr.PushLong, 0x10),
            Expr.And,
            Expr.Return,
        ),
        'loc_8096',
    )

    PlayChrAnimeClip(0xFFFE, 'BTL_MOVE', 0x01, 0x00, 0x00, 0x00, 0x00, -2.0, -1.0, -1.0, -1.0, 0x00, 0x00)

    Jump('loc_80BD')

    label('loc_8096')

    ExecExpressionWithReg(
        0x02,
        (
            (Expr.PushLong, 0x1),
            Expr.Nop,
            Expr.Return,
        ),
    )

    PlayChrAnimeClip(0xFFFE, 'BTL_MOVE', 0x01, 0x00, 0x00, 0x00, 0x00, -2.0, -1.0, -1.0, -1.0, 0x00, 0x00)

    label('loc_80BD')

    WaitAnimeClip(0xFFFE, 0.0, 0x00)

    Return()

def AniBtlInit():
    ReleaseEffect(0xFFFE, 0x25)
    LoadEffect(0xFFFE, 0x25, 'battle/atk034_1.eff')
    LoadEffect(0xFFFE, 0x26, 'battle/mgwa01_00.eff')
    # LoadEffect(0xFFFE, 0x26, 'battle/mglo01_06.eff')
    origFunc['AniBtlInit']()

def AniBtlAttack():
    ExecExpressionWithReg(
        0x10,
        (
            Expr.Rand,
            (Expr.PushLong, 3),
            Expr.Mod,
            Expr.Return,
        ),
    )

    # ExecExpressionWithReg(0x10, ((Expr.PushLong, 1), Expr.Return))

    BattleCmd(0x62, PseudoChrId.Target, 0x1A)
    BattleSetChrStatus(PseudoChrId.Self, BattleStatus.HPPercent, 100)
    BattleSetChrFlags(PseudoChrId.Target, BattleChrFlags.Controllable)
    BattleClearChrFlags(PseudoChrId.Target, BattleChrFlags.Enemy)

    return Return()


    ExecExpressionWithReg(
        0x10,
        (
            (Expr.Eval, 'BattleCmd(0x62, 0xFFFE, 0x14)'),
            (Expr.PushLong, 90),
            Expr.Mul,
            (Expr.PushLong, 100),
            Expr.Div,
            Expr.Return,
        ),
    )

    BattleCmd(0x61, 0xFFFE, 0x14, ParamInt(50))
    BattleCmd(0x61, 0xFFFE, 0x14, ArgReg(0x10))

    Return()
    return

    attr_wind   = 0
    attr_fire   = 1
    attr_ice    = 2
    attr_earth  = 3

    CameraCmd(0x00)
    BattleCmd(0x47)
    BattleCmd(0x48, 0xFFFE, 0x0001)
    BattleCmd(0x48, 0xFFFB, 0x0001)
    BattleCmd(0x46, 0.25, 6.0, 15.0)
    Call(ScriptId.BtlCom, 'AniBtlMove')
    BattleTurnChrDirection(0xFFFE, 0xFFFB, 0.0, 0.5)
    PlayChrAnimeClip(0xFFFE, 'BTL_ATTACK', 0x00, 0x00, 0x00, 0x00, 0x00, 0.2, -1.0, -1.0, -1.0, 0x00, 0x00)
    SetChrFace(0x03, 0xFFFE, '6', 'A', '', '#b', '0')
    Sleep(200)

    If(
        (
            (Expr.Eval, "BattleCmd(0x62, 0xFFFE, 0x0A)"),
            (Expr.PushLong, 0x2),
            Expr.Neq,
            Expr.Return,
        ),
        'loc_879A',
    )

    OP_3B(0x3A, 0xFFFE, (0xFF, 0x4F52, 0x0), (0xFF, 0x4F53, 0x0), (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0))

    def _loc_879A(): pass

    label('loc_879A')

    Sleep(550)

    SetChrFace(0x03, 0xFFFE, '6', 'B', '', '#b', '0')
    Sleep(130)

    EffectCmd(0x0F, 0xFFFE, 0x0022, 0x01)

    def attack_fire():
        PlayEffect(0xFFFE, (0xFF, 0x25, 0x0), 0xFFFE, 0x00000003, (0xDD, 'NODE_R_HAND'), (0xFF, 0x0, 0x0), (0xEE, 0.0, 0x0), (0xEE, 0.0, 0x0), 0.0, 0.0, 0.0, (0xEE, 0.9, 0x0), (0xEE, 0.9, 0x0), (0xEE, 0.9, 0x0), 0x02)

        # EffectCmd(0x14, 0xFFFE, 0x02, 0.0, 0.0, 100.0, 1.0, 0, 0x03)
        # EffectCmd(0x15, 0xFFFE, 0x02, 100.0, 100.0, 100.0, 1.0, 0, 0x03)

        OP_3B(0x00, (0xFF, 0x108F, 0x0), (0xEE, 0.800000011920929, 0x0), (0xFF, 0x64, 0x0), 0.0, (0xEE, -3.0, 0x0), 0x0000, 0xFFFF, 0.0, 0.0, 0.0, (0xFF, 0x0, 0x0), '', (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0), 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0.0)
        Sleep(800)

        OP_3B(0x00, (0xFF, 0x108B, 0x0), (0xEE, 1.0, 0x0), (0xFF, 0x0, 0x0), 0.0, (0xEE, 1.0, 0x0), 0x0000, 0xFFFF, 0.0, 0.0, 0.0, (0xFF, 0x0, 0x0), '', (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0), 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0.0)
        Sleep(133)

        BattleCmd(0x47)
        BattleCmd(0x48, 0xFFF9, 0x0001)
        BattleCmd(0x46, 0.5, 6.0, 15.0)
        Sleep(333)

        OP_3B(0x00, (0xFF, 0x107B, 0x0), (0xEE, 1.0, 0x0), (0xFF, 0x0, 0x0), 0.0, (0xEE, 0.0, 0x0), 0x0000, 0xFFFF, 0.0, 0.0, 0.0, (0xFF, 0x0, 0x0), '', (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0), 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0.0)
        Sleep(166)

        CreateThread(0xFFFE, 0x01, ScriptId.Current, 'AniBtlAttack_Damage')
        WaitForThreadExit(0xFFFE, 0x01)

        ForEachTarget(lambda: BattleSetChrAbnormalStatus(0xFFFB, AbnormalStatus.Burn, 0, 1))

        Sleep(666)
        WaitEffect(0xFFFE, 0x25, 0x00)

    def attack_wind():
        PlayEffect(0xFFFE, (0xFF, 0x23, 0x0), 0xFFFE, 0x00000003, (0xDD, 'NODE_R_HAND'), (0xEE, 0.0, 0x0), (0xEE, -0.019999999552965164, 0x0), (0xEE, 0.0, 0x0), 0.0, 0.0, 0.0, (0xEE, 1.0, 0x0), (0xEE, 1.0, 0x0), (0xEE, 1.0, 0x0), 0xFF)
        OP_3B(0x00, (0xFF, 0x8F1D, 0x0), (0xEE, 1.0, 0x0), (0xFF, 0x0, 0x0), 0.0, (0xEE, 0.0, 0x0), 0x0000, 0xFFFF, 0.0, 0.0, 0.0, (0xEE, 0.0, 0x0), '', (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0), 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0.0)
        OP_3B(0x00, (0xFF, 0x8FB3, 0x0), (0xEE, 0.5, 0x0), (0xFF, 0x0, 0x0), 0.0, (0xEE, 0.0, 0x0), 0x0000, 0xFFFE, 0.0, 0.0, 0.0, (0xEE, 0.0, 0x0), '', (0xFF, 0x3E8, 0x0), (0xFF, 0x12C, 0x0), 0x0000, 0x03E8, 0x0000, 0x0001, 0xFFFE, 0x0000, 0.0)
        BattleCmd(0x47)
        BattleCmd(0x48, 0xFFFB, 0x0001)
        BattleCmd(0x46, 0.5, 6.0, 15.0)
        Sleep(100)

        Sleep(400)

        CameraCmd(0x0A, 0.07, 0.05, 0.01, 30, 330, 150, 0, 0, 0x00)
        Call(ScriptId.BtlCom, 'AniBtlDamageTargets', (0xFF, 0x3FA, 0x0), (0xDD, 'NODE_CENTER'), (0xEE, 1.0, 0x0), (0xFF, 0x1, 0x0), (0xFF, 0xFFFF, 0x0), (0xEE, 0.5, 0x0), (0xEE, 0.0, 0x0))
        OP_3B(0x00, (0xFF, 0x10F3, 0x0), (0xEE, 1.0, 0x0), (0xFF, 0x64, 0x0), 0.0, (0xEE, 0.0, 0x0), 0x0000, 0xFFFF, 0.0, 0.0, 0.0, (0xEE, 0.0, 0x0), '', (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0), 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0.0)
        Sleep(200)

        Call(ScriptId.BtlCom, 'AniBtlDamageTargets', (0xFF, 0x3FA, 0x0), (0xDD, 'NODE_CENTER'), (0xEE, 1.0, 0x0), (0xFF, 0x3, 0x0), (0xFF, 0xFFFF, 0x0), (0xEE, 0.5, 0x0), (0xEE, 0.0, 0x0))
        OP_3B(0x00, (0xFF, 0x10F3, 0x0), (0xEE, 1.0, 0x0), (0xFF, 0x64, 0x0), 0.0, (0xEE, 0.0, 0x0), 0x0000, 0xFFFF, 0.0, 0.0, 0.0, (0xEE, 0.0, 0x0), '', (0xFF, 0x0, 0x0), (0xFF, 0x0, 0x0), 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0.0)
        OP_3B(0x01, (0xFF, 0x8FB3, 0x0), (0xFF, 0x7D0, 0x0))
        Sleep(100)

        ForEachTarget(lambda: BattleSetChrAbnormalStatus(0xFFFB, AbnormalStatus.Seal, 0, 1))

    def attack_ice():
        PlayEffect(0xFFFE, (0xFF, 0x26, 0x0), 0xFFFE, 0x00000003, (0xDD, ''), (0xEE, 0.0, 0x0), (0xEE, 0.1, 0x0), (0xEE, 2.0, 0x0), 0.0, 0.0, 0.0, (0xEE, 1.0, 0x0), (0xEE, 1.0, 0x0), (0xEE, 1.0, 0x0), 0xFF)
        Sleep(1500)

        CreateThread(0xFFFE, 0x01, ScriptId.Current, 'AniBtlAttack_Damage')
        WaitForThreadExit(0xFFFE, 0x01)
        ForEachTarget(lambda: BattleSetChrAbnormalStatus(0xFFFB, AbnormalStatus.Freeze, 1, 1))
        Sleep(1000)

    Switch2(
        (
            (Expr.PushReg, 0x10),
            Expr.Return,
        ),
        {
            attr_wind   : attack_wind,
            attr_fire   : attack_fire,
            attr_ice    : attack_ice,
            attr_earth  : lambda: None,
        },
    )

    SetChrFace(0x03, 0xFFFE, '6', '8', '', '#b', '0')
    Sleep(150)

    SetChrFace(0x03, 0xFFFE, '6', '0', '', '#b', '0')
    Sleep(100)

    SetChrFace(0x03, 0xFFFE, '2', '0', '', '#b', '0')
    PlayEffect(0xFFFE, (0xFF, 0x22, 0x0), 0xFFFE, 0x00000003, (0xDD, 'NODE_R_HAND'), (0xEE, 0.0, 0x0), (0xEE, -0.07000000029802322, 0x0), (0xEE, 0.0, 0x0), 0.0, 0.0, 0.0, (0xEE, 1.0, 0x0), (0xEE, 1.0, 0x0), (0xEE, 1.0, 0x0), 0x02)
    WaitAnimeClip(0xFFFE, 0.0, 0x00)

    Return()

def AniBtlAttack_Damage():
    def cb():
        BattleDamageAnime(0xFFFB, (0xEE, 0.5, 0x0), (0xEE, 0.800000011920929, 0x0), 0x01)
        PlayEffect(0xFFFE, (0xFF, 0x3FA, 0x0), 0xFFFB, 0x0000000C, (0xDD, 'NODE_CENTER'), (0xEE, 0.0, 0x0), (0xEE, 0.0, 0x0), (0xEE, 0.0, 0x0), 0.0, 0.0, 0.0, (0xEE, 0.800000011920929, 0x0), (0xEE, 0.800000011920929, 0x0), (0xEE, 0.800000011920929, 0x0), 0xFF)
        Sleep(50)
        BattleDamage(0xFFFB, 0xFFFE, 0x64, 0x00)

    ForEachTarget(cb)
